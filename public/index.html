<!DOCTYPE html>
<html lang="en">
<head>
    <title>File System</title>
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>

<div class="container">

    <h2>File System</h2>

    <a href="#" onclick="goHome()">Home</a>

    <p id="breadcrumb"></p>

    <table id="file-table">

        <thead>
        <tr>
            <th></th>
            <th style="width:50%;">Name</th>
            <th style="width:25%">Date Modified</th>
            <th>Type</th>
            <th>Size</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="file-table-body">

        </tbody>

    </table>

    <br>
    <button onclick="zipItems()">Download selected items as .zip</button>

</div>

<script>
    const baseURL = "http://localhost:1234";
    const homeName = "File System";
    let currentPath = homeName;

    window.addEventListener('load', goHome);

    async function fetchData(url) {
        const response = await fetch(url);
        return response.json();
    }

    /**
     * Change the directory to root directory of the file system
     * */
    async function goHome() {
        currentPath = homeName;
        const data = await fetchData(baseURL + '/home');
        updateTable(data);
        updateBreadcrumb();
    }

    /**
     * Change the directory to the specified argument, which is a child directory of the current path
     * */
    async function changeDir(folderName) {
        currentPath = `${currentPath}/${folderName}`;
        const data = await fetchData(baseURL + `/dir?url=${currentPath}`);
        updateTable(data);
        updateBreadcrumb();
    }

    /**
     * Change the directory to the parent directory of the current path
     * */
    async function goUp() {
        // Remove last directory from path
        const pathParts = currentPath.split('/');
        const newPath = pathParts.slice(0, -1).join('/');
        currentPath = newPath;
        const data = await fetchData(baseURL + `/dir?url=${newPath}`);
        updateTable(data);
        updateBreadcrumb();
    }

    /**
     * Clear the <tbody> element and add new rows from the JSON data received returned after making a GET request
     * */
    function updateTable(data) {
        const tableBody = document.getElementById('file-table-body');
        tableBody.innerHTML = '';

        for (const item of data) {
            const row = tableBody.insertRow(-1);
            const cell1 = row.insertCell(0); // Checkboxes
            const cell2 = row.insertCell(1); // Name
            const cell3 = row.insertCell(2); // Date Modified
            const cell4 = row.insertCell(3); // Type
            const cell5 = row.insertCell(4); // Size
            const cell6 = row.insertCell(5); // Action

            // If the item name is not '..', then add a checkbox
            cell1.innerHTML = item.name !== '..' ? `<input type="checkbox" value="${item.name}">` : '';

            if (item.name === '..') {
                cell2.innerHTML = `<img class="arrow" src="folder_up.png" onclick="goUp()">`;
            } else if (item.type === "Folder") {
                cell2.innerHTML = `<a href="#" onclick="changeDir('${item.name}')">${item.name}</a>`;
            } else if (item.type === "File") {
                cell2.innerHTML = item.name;
            }

            cell3.innerHTML = item.date;
            cell4.innerHTML = item.type;

            if (item.type === "File") {
                cell5.innerHTML = item.size;
                cell6.innerHTML = `<button onclick="window.location.href='/download?filepath=${item.url}'">Download</button>`;
            }
        }
    }

    /** Updates the breadcrumb in the page to match the current path. */
    function updateBreadcrumb() {
        document.getElementById("breadcrumb").textContent = currentPath;
    }

    /** Gets all selected checkboxes, appends their value(name) to the current path and make a get request
     *  to the /zip resource with them as parameters
     */
    function zipItems() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const selectedItems = Array.from(checkboxes).map(checkbox => `${currentPath}/${checkbox.value}`);
        window.location.href = `/zip?files=${selectedItems.join()}`;
    }

</script>

</body>
</html>