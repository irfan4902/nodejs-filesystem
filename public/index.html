<!DOCTYPE html>
<html lang="en">
<head>
    <title>File System</title>
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>

<div class="container">

    <h2>File System</h2>

    <a href="#" onclick="goHome()">Home</a>

    <p id="breadcrumb"></p>

    <table id="file-table">

        <thead>
        <tr>
            <th></th>
            <th style="width:50%;">Name</th>
            <th style="width:25%">Date Modified</th>
            <th>Type</th>
            <th>Size</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="file-table-body">

        </tbody>

    </table>

    <button onclick="zipItems()">Download selected items as .zip</button>

</div>

<script>
    const baseURL = "http://localhost:1234";
    const homeName = "NLF File System";
    let currentPath = homeName;

    window.addEventListener('load', goHome);

    async function goHome() {
        console.log("Current path: ", currentPath);
        currentPath = homeName;
        console.log("Changing directory into: ", currentPath);

        const res = await fetch(baseURL + '/home',
            {
                method: 'GET'
            });
        console.log(res);

        const data = await res.json();
        console.log(data);

        updatePage(data, currentPath);
    }

    async function changeDir(folderName) {
        console.log("Current path: ", currentPath);
        currentPath = `${currentPath}/${folderName}`;

        console.log("Changing directory into: ", currentPath);
        const res = await fetch(baseURL + `/dir?url=${currentPath}`,
            {
                method: 'GET'
            });
        console.log(res);
        const data = await res.json();
        console.log(data);

        updatePage(data, currentPath);
    }

    async function goUp() {
        console.log("Current path: ", currentPath);

        const pathParts = currentPath.split('/'); // Split the path by slashes
        // Remove the last directory
        const newPath = pathParts.slice(0, -1).join('/');

        currentPath = newPath;

        console.log("Changing directory into: ", newPath);
        const res = await fetch(baseURL + `/dir?url=${newPath}`,
            {
                method: 'GET'
            });
        console.log(res);
        const data = await res.json();
        console.log(data);

        updatePage(data, currentPath);
    }

    function updatePage(data, path){
        // Clear table
        document.getElementById('file-table-body').innerHTML = '';

        // Add rows to table
        for (const item of data) {
            let table = document.getElementById("file-table-body");
            let row = table.insertRow(-1);
            let cell1 = row.insertCell(0); // Checkbox
            let cell2 = row.insertCell(1); // Name
            let cell3 = row.insertCell(2); // Date
            let cell4 = row.insertCell(3); // Type
            let cell5 = row.insertCell(4); // Size
            let cell6 = row.insertCell(5); // Action

            // Do not have a checkbox beside the '..' item at the top of the list
            if (item.name !== '..') {
                cell1.innerHTML = `<input type="checkbox" value="${item.name}">`
            }

            if (item.type === "Folder") {
                // Names of folders should be clickable links
                cell2.innerHTML = `<a href="#" onclick="changeDir('${item.name}')">${item.name}</a>`

                // Clicking on '..' should bring you up one directory
                if (item.name === '..') {
                    cell2.innerHTML = `<a href="#" onclick="goUp()">${item.name}</a>`
                }
            } else {
                cell2.innerHTML = item.name;
            }

            cell3.innerHTML = item.date;
            cell4.innerHTML = item.type;

            if (item.type === "File") {
                cell5.innerHTML = item.size;
                cell6.innerHTML = `<button onclick="window.location.href='/download?filepath=${item.url}'">Download</button>`;
            }
        }

        // Update breadcrumb
        document.getElementById("breadcrumb").textContent = currentPath;
    }

    function zipItems() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const selectedItems = [];

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedItems.push(`${currentPath}/${checkbox.value}`);
            }
        });
        console.log(selectedItems);

        window.location.href = `/zip?files=${selectedItems.toString()}`;
    }

</script>


</body>
</html>