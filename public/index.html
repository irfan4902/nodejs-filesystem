<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>

<div class="container">

    <h2>File System</h2>

    <a href="#" onclick="goHome()">Home</a>

    <p id="breadcrumb"></p>

    <table id="file-table">

        <thead>
        <tr>
            <th></th>
            <th style="width:50%;">Name</th>
            <th style="width:25%">Date Modified</th>
            <th>Type</th>
            <th>Size</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody id="file-table-body">

        </tbody>

    </table>

    <button onclick="getSelectedItems()">Download selected items as .zip</button>

</div>

<script>
    // Once the webpage loads, do the getInfo function
    const baseURL = 'http://localhost:1234/info';
    window.addEventListener('load', getInfo());

    async function getInfo() {
        const res = await fetch(baseURL,
            {
                method: 'GET'
            });
        console.log(res);

        const data = await res.json();
        console.log(data);

        for (const item of (data.slice(0, -1))) {
            addRow(item.name, item.date, item.type, item.size);
        }

        document.getElementById("breadcrumb").textContent = data.at(-1).path;
    }

    async function changeDir(folderName) {
        clearTable();

        let newURL = `http://localhost:1234/info2?url=${folderName}`;

        const res = await fetch(newURL,
            {
                method: 'GET'
            });
        console.log(res);

        const data = await res.json();
        console.log(data);

        for (const item of (data.slice(0, -1))) {
            addRow(item.name, item.date, item.type, item.size);
        }

        document.getElementById("breadcrumb").textContent = data.at(-1).path;
    }

    async function goHome() {
        clearTable();
        let newURL = `http://localhost:1234/home`;

        const res = await fetch(newURL,
            {
                method: 'GET'
            });
        console.log(res);

        const data = await res.json();
        console.log(data);

        for (const item of (data.slice(0, -1))) {
            addRow(item.name, item.date, item.type, item.size);
        }

        document.getElementById("breadcrumb").textContent = data.at(-1).path;
    }

    function clearTable() {
        document.getElementById('file-table-body').innerHTML = '';
    }

    function addRow(name, date, type, size) {
        let table = document.getElementById("file-table-body");
        let row = table.insertRow(-1);
        let cell1 = row.insertCell(0); // Checkbox
        let cell2 = row.insertCell(1); // Name
        let cell3 = row.insertCell(2); // Date
        let cell4 = row.insertCell(3); // Type
        let cell5 = row.insertCell(4); // Size
        let cell6 = row.insertCell(5); // Action

        if (name != '..') {
            cell1.innerHTML = `<input type="checkbox" value="${name}">`
        }

        if (type === "Folder") {
            cell2.innerHTML = `<a href="#" onclick="changeDir('${name}')">${name}</a>`
        } else {
            cell2.innerHTML = name;
        }

        cell3.innerHTML = date;
        cell4.innerHTML = type;

        if (type === "File") {
            cell5.innerHTML = size;
            cell6.innerHTML = `<button onclick="window.location.href='/download?filename=${name}'">Download</button>`;
        }
    }

    function getSelectedItems() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const selectedItems = [];

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedItems.push(checkbox.value);
            }
        });

        console.log(selectedItems);

        window.location.href=`/zip?files=${selectedItems.toString()}`;
    }
</script>
</body>
</html>